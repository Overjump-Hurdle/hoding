## 사용자 수에 따른 규모 확장성
madeBy hoding  
date 23.11.26  
reference [가상 면접 사례로 배우는 대규모 시스템 설계 기초](https://product.kyobobook.co.kr/detail/S000001033116)    


### nosql 선택기준
- 낮은 응답 지연시간이 요구
- 다르는 데이터가 비정형
- 직렬화,역질렬화 할 수 있기만 하면 됨
- 아주 많은 양의 데이터를 저장해야 됨

### 수직적 확장 vs 수평적 확장
- 수직적 규모확장에는 한계가 있다.
- 수직적 규모확장은 자동복구나 다중화 방안을 제시하지 않는다.

### 로드밸런서
- 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할

### 데이터베이스 다중화
- master - slave
- 쓰기연산은 마스터에서만 지원한다.
- 슬레이브는 마스터로부터 사본을 전달받으며 읽기 연산만 지원한다.
- 마스터 데이터베이스가 다운되면 슬레이브가 마스터로 승격한다.

### 캐시
- 읽기 주도형 캐시 젼락: 우선 캐시 탐색 부재시 DB 탐색

#### 캐시 사용시 유의할 점
- 만료시간: 짧을수록 DB에 많이 접근함, 길수록 원본데이터와 차이가 날 수 있음
- 일관성: 원본을 갱신할때 캐시도 갱신해야하는데 단일 트랜잭션으로 처리되지 않으면 일관성이 깨진다.
- SPOF(단일 장애 지점) : 캐시 서버를 한대만 두게 되면 SPOF
- 캐시 메모리 크기 : 작을수록 데이터가 밀려나서 성능이 떨어진다.
- 데이터 방출 정책 : 캐시가 꽉차버렸을때 데이터 내보내는 정책 LRU(사용된지 오래된거),LFU(적게 사용된),FIFO

### CDN
- 정적 콘텐츠 캐시  
- 적절한 TTL(time-to-live) 설정 -> 신선도 결정
- CDN 장애 발생시 원본 접근처리

### 무상태(stateless) 웹계층
- 상태정보(ex.세션)이 웹계층에서 제거되고 DB에서 관리 되는 것
- DB에서 관리하지 않고 로드밸런서에 고정세션을 사용해도 되는데 로드밸런서에 부담을 줌

### 데이터 센터
- 다중 데이터 센터에서 geoDNS는 사용자 위치에 지리적으로 가까운 데이터센타를 라우팅해준다.
- 장애 발생시 데이터 센터간 데이터 동기화문제가 있다.

### 메시지 큐
- 무손실을 보장하는 비동기 통신 컴포넌트
- 메시지 버퍼 역할
- pub/sub 구조
- 서버간 결합을 느슨하게 만들 수 있다.

### 데이터 베이스 규모 확장
- 알쓸신잡 : 스택오버플로우는 천만명의 사용자를 단일 DB로 처리한다.
#### 샤딩 : 수평적 확장
- 데이터베이스를 샤드라고 부르는 작은 단위로 분할하고 샤드에 보관되는 데이터 사이에는 중복이 없다.
- 한개의 테이블을 여러개의 DB에 나누어 저장하는 느낌
- 예를 들어 user_id%4로 저장될 DB를 결정한다. 이값을 샤딩키(파티션 키) 라고 한다.

#### 샤딩 문제점
- 재샤딩 : 샤드를 증설할때 샤드의 키를 계산하는 함수를 변경하고 데이터를 재배치 해야한다. (이후 안정해시 연관)
- celebrity 문제 : 한 샤드에 트래픽이 집중될 수 있다.
- 조인과 비정규화: 샤드끼리 조인이 어려워 비정규화를 진행하는 것


### 정리
- 웹 계층은 무상태 계층으로 
- 모든 계층에 다중화 도입 
- 가능한 많은 데이터를 캐시할 것 
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스 
- 데이터 계층은 샤딩을 통해 규모를 확장할 것 
- 각 게층은 독립적으 서비스로 분할할 것 
- 시스템을 지속적으로 모니터링하고 자동화 도구들을 활용할 것